<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>服装计件统计系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        
        :root {
            --primary: #3498db;
            --primary-dark: #2980b9;
            --secondary: #2c3e50;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --border: #e0e6ed;
            --table-border: #d1d9e0;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: #333;
            line-height: 1.5;
            padding: 12px;
            min-height: 100vh;
            font-size: 14px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding-bottom: 70px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        h1 {
            font-size: 1.3rem;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        h1 i {
            color: var(--primary);
        }
        
        .month-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .month-selector button {
            background: var(--primary);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 1px 4px rgba(52, 152, 219, 0.3);
            transition: all 0.2s ease;
        }
        
        .month-selector button:active {
            transform: scale(0.95);
        }
        
        .month-selector span {
            font-weight: 600;
            font-size: 1.0rem;
            min-width: 100px;
            text-align: center;
        }
        
        /* 日期筛选控件 */
        .date-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            background: white;
            padding: 12px 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            align-items: center;
            flex-wrap: wrap;
        }
        
        .date-range-selector {
            display: flex;
            align-items: center;
            gap: 5px;
            flex: 1;
            min-width: 0;
            flex-wrap: nowrap;
        }
        
        .date-range-selector input {
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            min-width: 0;
            width: 100%;
            max-width: 110px;
        }
        
        .date-range-selector span {
            white-space: nowrap;
            font-size: 0.9rem;
        }
        
        .date-range-display {
            flex: 1;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            font-weight: 600;
            padding: 0 10px;
            min-width: 0;
        }
        
        .filter-controls {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
        }
        
        .filter-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }
        
        .filter-btn:hover {
            background: var(--primary-dark);
        }
        
        .clear-filter-btn {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }
        
        .clear-filter-btn:hover {
            background: #c0392b;
        }
        
        .stats-card {
            background: white;
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
        }
        
        .stat-item {
            text-align: center;
            padding: 6px;
            border-radius: 8px;
            background: var(--light);
        }
        
        .stat-item .value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            margin: 2px 0;
            line-height: 1.2;
        }
        
        .stat-item .label {
            font-size: 0.7rem;
            color: var(--gray);
        }
        
        .tables-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }
        
        .daily-table-container {
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid #eaeaea;
            overflow: hidden;
        }
        
        .daily-header {
            background: #f0f7ff;
            padding: 8px 12px;
            font-weight: 600;
            color: var(--primary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .daily-date {
            font-size: 0.95rem;
        }
        
        .daily-summary {
            font-size: 0.85rem;
        }
        
        .records-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            table-layout: fixed;
        }
        
        .records-table th,
        .records-table td {
            text-align: center;
            padding: 6px 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .records-table th {
            background: var(--primary);
            color: white;
            font-weight: 600;
            padding: 8px 4px;
            position: sticky;
            top: 0;
            font-size: 12px;
            border: 1px solid var(--primary-dark);
        }
        
        .records-table td {
            border: 1px solid var(--table-border);
            color: var(--dark);
            line-height: 1.3;
        }
        
        .date-cell {
            width: 70px;
            font-size: 0.9rem;
        }
        
        .size-cell {
            width: 80px;
        }
        
        .quantity-cell {
            width: 50px;
        }
        
        .price-cell {
            width: 60px;
        }
        
        .total-cell {
            width: 70px;
            text-align: right;
            padding-right: 8px;
        }
        
        .action-cell {
            width: 70px;
            padding: 4px;
        }
        
        .day-total-row td {
            background: #e1f0fa;
            font-weight: 600;
            color: var(--primary);
            border-top: 2px solid var(--primary);
            padding: 8px 4px;
        }
        
        .action-btn {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 11px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .action-btn.edit-btn {
            color: var(--primary);
        }
        
        .action-btn.delete-btn {
            color: var(--danger);
        }
        
        .action-btn:hover {
            background: rgba(0,0,0,0.05);
        }
        
        .add-record-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 45px;
            height: 45px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 12px rgba(52, 152, 219, 0.4);
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s ease;
        }
        
        .add-record-btn:active {
            transform: scale(0.95);
        }
        
        .month-total {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--secondary);
            color: white;
            padding: 14px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .total-amount {
            color: #f1c40f;
            font-size: 1.3rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
            padding: 15px;
        }
        
        .modal-content {
            background: white;
            width: 100%;
            max-width: 450px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            animation: modalOpen 0.3s ease;
        }
        
        @keyframes modalOpen {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            background: var(--primary);
            color: white;
            padding: 16px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 1.4rem;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-modal:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .modal-body {
            padding: 18px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--secondary);
            font-size: 0.9rem;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 11px 13px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 0.95rem;
            transition: border 0.2s ease;
        }
        
        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .form-row {
            display: flex;
            gap: 12px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .modal-footer {
            display: flex;
            padding: 12px 16px 16px;
            gap: 12px;
        }
        
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-cancel {
            background: #ecf0f1;
            color: var(--gray);
        }
        
        .btn-cancel:hover {
            background: #dfe4e6;
        }
        
        .btn-save {
            background: var(--success);
            color: white;
        }
        
        .btn-save:hover {
            background: #219653;
        }
        
        .empty-state {
            text-align: center;
            padding: 20px 15px;
            color: var(--gray);
        }
        
        .empty-state i {
            font-size: 2.0rem;
            margin-bottom: 8px;
            color: #d0d5dd;
        }
        
        .empty-state p {
            font-size: 0.9rem;
        }
        
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 1001;
            animation: toastFade 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .toast.success {
            background: rgba(39, 174, 96, 0.9);
        }
        
        .toast.error {
            background: rgba(231, 76, 60, 0.9);
        }
        
        @keyframes toastFade {
            0% { opacity: 0; transform: translate(-50%, -40%); }
            100% { opacity: 1; transform: translate(-50%, -50%); }
        }
        
        /* 删除确认弹窗 */
        .delete-confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .delete-confirm-content {
            background: white;
            width: 100%;
            max-width: 350px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }
        
        .delete-confirm-body {
            padding: 20px;
            text-align: center;
            font-size: 1.1rem;
        }
        
        .delete-confirm-footer {
            display: flex;
            padding: 12px 16px;
            gap: 12px;
        }
        
        /* 新增：日期选择器限制样式 */
        .date-range-selector input:invalid {
            border-color: var(--danger);
            background-color: rgba(231, 76, 60, 0.05);
        }
        
        .date-error {
            color: var(--danger);
            font-size: 0.8rem;
            margin-top: 4px;
            display: none;
        }
        
        /* 手机端优化 */
        @media (max-width: 480px) {
            header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
            
            .month-selector {
                align-self: stretch;
                justify-content: space-between;
            }
            
            .month-selector span {
                min-width: auto;
            }
            
            .date-filter {
                flex-direction: row;
                gap: 5px;
                padding: 10px;
                flex-wrap: nowrap;
                overflow-x: auto;
            }
            
            .date-range-selector {
                flex: 1;
                min-width: 200px;
                gap: 3px;
            }
            
            .date-range-selector input {
                max-width: 90px;
                padding: 6px;
                font-size: 0.85rem;
            }
            
            .date-range-selector span {
                font-size: 0.8rem;
                padding: 0 2px;
            }
            
            .filter-controls {
                flex-shrink: 0;
                gap: 5px;
            }
            
            .filter-btn, .clear-filter-btn {
                padding: 6px 10px;
                font-size: 0.85rem;
            }
            
            .stats-card {
                grid-template-columns: repeat(4, 1fr);
                gap: 3px;
                padding: 6px;
            }
            
            .stat-item {
                padding: 4px;
            }
            
            .stat-item .value {
                font-size: 0.9rem;
            }
            
            .stat-item .label {
                font-size: 0.65rem;
            }
            
            .records-table th, 
            .records-table td {
                padding: 6px 2px;
                font-size: 10px;
            }
            
            .daily-header {
                padding: 6px 10px;
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            
            .daily-date {
                font-size: 0.9rem;
            }
            
            .daily-summary {
                font-size: 0.8rem;
            }
            
            .date-cell {
                width: 65px;
                font-size: 0.8rem;
            }
            
            .size-cell {
                width: 65px;
            }
            
            .quantity-cell {
                width: 35px;
            }
            
            .price-cell {
                width: 45px;
            }
            
            .total-cell {
                width: 55px;
            }
            
            .action-cell {
                width: 50px;
            }
            
            .month-total {
                font-size: 1.0rem;
                padding: 12px 16px;
            }
            
            .total-amount {
                font-size: 1.2rem;
            }
            
            .add-record-btn {
                bottom: 70px;
                width: 42px;
                height: 42px;
                font-size: 1.3rem;
            }
            
            /* 手机端模态框居中 */
            .modal {
                align-items: center;
                animation: none;
            }
            
            .modal-content {
                animation: modalOpen 0.3s ease;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-tshirt"></i> 服装计件统计系统</h1>
            <div class="month-selector">
                <button id="prev-month"><i class="fas fa-chevron-left"></i></button>
                <span id="current-month">2025年6月</span>
                <button id="next-month"><i class="fas fa-chevron-right"></i></button>
            </div>
        </header>
        
        <!-- 日期筛选控件 -->
        <div class="date-filter">
            <div class="date-range-selector">
                <input type="date" id="start-date-input" required>
                <span>至</span>
                <input type="date" id="end-date-input" required>
            </div>
            <div class="filter-controls">
                <button class="filter-btn" id="apply-filter">
                    <i class="fas fa-filter"></i> 筛选
                </button>
                <button class="clear-filter-btn" id="clear-filter">
                    <i class="fas fa-times"></i> 清除
                </button>
            </div>
        </div>
        
        <div class="stats-card">
            <div class="stat-item">
                <div class="value" id="work-days">0</div>
                <div class="label">工作天数</div>
            </div>
            <div class="stat-item">
                <div class="value" id="total-pieces">0</div>
                <div class="label">总件数</div>
            </div>
            <div class="stat-item">
                <div class="value" id="total-styles">0</div>
                <div class="label">款式数量</div>
            </div>
            <div class="stat-item">
                <div class="value" id="month-income">¥0</div>
                <div class="label" id="income-label">当月收入</div>
            </div>
        </div>
        
        <div class="tables-container" id="tables-container">
            <!-- 每日表格将在这里动态生成 -->
        </div>
        
        <button class="add-record-btn" id="add-record">
            <i class="fas fa-plus"></i>
        </button>
        
        <div class="month-total">
            <span>总收入：</span>
            <span class="total-amount" id="month-total-amount">¥0.00</span>
        </div>
        
        <!-- 添加/编辑记录模态框 -->
        <div class="modal" id="record-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <span id="modal-title">添加计件记录</span>
                    <button class="close-modal" id="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="record-form">
                        <input type="hidden" id="record-id">
                        <div class="form-group">
                            <label for="record-date"><i class="fas fa-calendar"></i> 日期</label>
                            <input type="date" id="record-date" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="clothing-style"><i class="fas fa-ruler"></i> 款式</label>
                                <select id="clothing-style" required>
                                    <option value="">选择款式</option>
                                    <option value="长裤">长裤</option>
                                    <option value="短裤">短裤</option>
                                    <option value="衬衫">衬衫</option>
                                    <option value="外套">外套</option>
                                    <option value="custom">其他款式</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="size"><i class="fas fa-ruler-combined"></i> 尺码</label>
                                <input type="number" id="size" min="20" max="60" step="1" value="32" required>
                            </div>
                        </div>
                        <div class="form-group" id="custom-style-group" style="display: none;">
                            <label for="custom-style"><i class="fas fa-pen"></i> 款式名称</label>
                            <input type="text" id="custom-style" placeholder="输入自定义款式名称">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="quantity"><i class="fas fa-calculator"></i> 数量</label>
                                <input type="number" id="quantity" min="1" value="1" required>
                            </div>
                            <div class="form-group">
                                <label for="unit-price"><i class="fas fa-tag"></i> 单价 (元)</label>
                                <input type="number" id="unit-price" step="0.5" min="0" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-cancel" id="cancel-record">取消</button>
                    <button type="button" class="btn btn-save" id="save-record">保存记录</button>
                </div>
            </div>
        </div>
        
        <!-- 删除确认模态框 -->
        <div class="delete-confirm-modal" id="delete-confirm-modal">
            <div class="delete-confirm-content">
                <div class="modal-header">
                    <span>确认删除</span>
                    <button class="close-modal" id="close-delete-modal">&times;</button>
                </div>
                <div class="delete-confirm-body">
                    <p>确定要删除这条记录吗？删除后不可恢复</p>
                </div>
                <div class="delete-confirm-footer">
                    <button class="btn btn-cancel" id="cancel-delete">取消</button>
                    <button class="btn btn-save" id="confirm-delete">确定删除</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // 数据存储键（localStorage用）
    const STORAGE_KEY = 'pants_records';
    
    // 当前日期逻辑（默认取系统时间2025-06-07）
    const now = new Date('2025-06-07'); 
    let currentMonth = now.getMonth();
    let currentYear = now.getFullYear();
    let editingRecordId = null;   // 编辑中的记录ID（null表示"添加"状态）
    let filterStartDate = null;  // 筛选起始日期
    let filterEndDate = null;    // 筛选结束日期
    let isFilterApplied = false; // 是否处于筛选状态
    let recordToDelete = null;   // 待删除记录ID
    
    // DOM元素绑定
    const monthDisplay = document.getElementById('current-month');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const addRecordBtn = document.getElementById('add-record');
    const recordModal = document.getElementById('record-modal');
    const closeModalBtn = document.getElementById('close-modal');
    const cancelRecordBtn = document.getElementById('cancel-record');
    const saveRecordBtn = document.getElementById('save-record');
    const tablesContainer = document.getElementById('tables-container');
    const applyFilterBtn = document.getElementById('apply-filter');
    const clearFilterBtn = document.getElementById('clear-filter');
    const startDateInput = document.getElementById('start-date-input');
    const endDateInput = document.getElementById('end-date-input');
    const incomeLabel = document.getElementById('income-label');
    
    // 新增款式下拉框和单价输入框
    const clothingStyleSelect = document.getElementById('clothing-style');
    const sizeInput = document.getElementById('size');
    const unitPriceInput = document.getElementById('unit-price');
    const customStyleGroup = document.getElementById('custom-style-group');
    const customStyleInput = document.getElementById('custom-style');
    
    // 统计信息元素
    const workDaysEl = document.getElementById('work-days');
    const totalPiecesEl = document.getElementById('total-pieces');
    const totalStylesEl = document.getElementById('total-styles');
    const monthIncomeEl = document.getElementById('month-income');
    const monthTotalAmountEl = document.getElementById('month-total-amount');
    
    // 删除确认弹窗元素
    const deleteConfirmModal = document.getElementById('delete-confirm-modal');
    const closeDeleteModalBtn = document.getElementById('close-delete-modal');
    const cancelDeleteBtn = document.getElementById('cancel-delete');
    const confirmDeleteBtn = document.getElementById('confirm-delete');
    
    // 页面加载初始化
    document.addEventListener('DOMContentLoaded', () => {
        resetFilterDates();   // 重置筛选日期为"当月1日 ~ 当月最后1日"
        updateMonthDisplay(); // 更新顶部月份显示
        renderRecords();      // 渲染所有记录（含筛选逻辑）
        bindEventListeners(); // 绑定所有交互事件
        
        // 添加款式选择事件监听
        clothingStyleSelect.addEventListener('change', function() {
            if (this.value === '长裤') {
                unitPriceInput.value = '7.5';
                customStyleGroup.style.display = 'none';
            } else if (this.value === '短裤') {
                unitPriceInput.value = '6.0';
                customStyleGroup.style.display = 'none';
            } else if (this.value === '衬衫') {
                unitPriceInput.value = '8.0';
                customStyleGroup.style.display = 'none';
            } else if (this.value === '外套') {
                unitPriceInput.value = '12.0';
                customStyleGroup.style.display = 'none';
            } else if (this.value === 'custom') {
                customStyleGroup.style.display = 'block';
                unitPriceInput.value = '';
            }
        });
        
        // 日期输入验证
        startDateInput.addEventListener('change', validateDateRange);
        endDateInput.addEventListener('change', validateDateRange);
    });
    
    // 验证日期范围
    function validateDateRange() {
        const startVal = startDateInput.value;
        const endVal = endDateInput.value;
        
        if (!startVal || !endVal) return;
        
        const startDate = new Date(startVal);
        const endDate = new Date(endVal);
        
        if (startDate > endDate) {
            applyFilterBtn.disabled = true;
            applyFilterBtn.style.opacity = '0.6';
            applyFilterBtn.style.cursor = 'not-allowed';
        } else {
            applyFilterBtn.disabled = false;
            applyFilterBtn.style.opacity = '1';
            applyFilterBtn.style.cursor = 'pointer';
        }
    }
    
    // 绑定所有事件监听器
    function bindEventListeners() {
        // 月份切换按钮
        prevMonthBtn.addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            isFilterApplied = false; // 切换月份时退出筛选
            resetFilterDates();
            updateMonthDisplay();
            renderRecords();
        });
        nextMonthBtn.addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            isFilterApplied = false; // 切换月份时退出筛选
            resetFilterDates();
            updateMonthDisplay();
            renderRecords();
        });
        
        // 增删改模态框相关
        addRecordBtn.addEventListener('click', openAddModal);
        closeModalBtn.addEventListener('click', () => recordModal.style.display = 'none');
        cancelRecordBtn.addEventListener('click', () => recordModal.style.display = 'none');
        saveRecordBtn.addEventListener('click', saveRecord);
        
        // 日期筛选按钮
        applyFilterBtn.addEventListener('click', applyDateFilter);
        clearFilterBtn.addEventListener('click', clearDateFilter);
        
        // 动态按钮委托（编辑/删除）
        tablesContainer.addEventListener('click', (e) => {
            const target = e.target;
            const btn = target.closest('.action-btn');
            
            if (!btn) return;
            
            const recordId = btn.getAttribute('data-id');
            
            if (btn.classList.contains('edit-btn')) {
                openEditModal(recordId);
            } else if (btn.classList.contains('delete-btn')) {
                openDeleteModal(recordId);
            }
        });
        
        // 删除确认弹窗事件
        closeDeleteModalBtn.addEventListener('click', closeDeleteModal);
        cancelDeleteBtn.addEventListener('click', closeDeleteModal);
        confirmDeleteBtn.addEventListener('click', confirmDelete);
    }
    
    // 重置筛选日期为"当月1日 ~ 当月最后1日"
    function resetFilterDates() {
        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);
        
        filterStartDate = firstDay;
        filterEndDate = lastDay;
        isFilterApplied = false;
        
        // 设置日期输入框的值
        startDateInput.value = formatDate(firstDay);
        endDateInput.value = formatDate(lastDay);
        
        // 重置验证状态
        applyFilterBtn.disabled = false;
        applyFilterBtn.style.opacity = '1';
        applyFilterBtn.style.cursor = 'pointer';
        
        updateMonthDisplay();
    }
    
    // 日期格式化（转为YYYY-MM-DD）
    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    // 日期格式化显示（YYYY/MM/DD）
    function formatDateForDisplay(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}/${month}/${day}`;
    }
    
    // 更新顶部月份显示（筛选时显示范围，非筛选时显示年月）
    function updateMonthDisplay() {
        if (isFilterApplied) {
            const start = formatDate(filterStartDate);
            const end = formatDate(filterEndDate);
            monthDisplay.textContent = `${start} 至 ${end}`;
        } else {
            const monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', 
                              '7月', '8月', '9月', '10月', '11月', '12月'];
            monthDisplay.textContent = `${currentYear}年${monthNames[currentMonth]}`;
        }
        
        // 更新收入标签
        incomeLabel.textContent = isFilterApplied ? '当前收入' : '当月收入';
    }
    
    // -------------------- 记录数据操作 --------------------
    // 获取所有记录（从localStorage读取）
    function getRecords() {
        const recordsJson = localStorage.getItem(STORAGE_KEY);
        return recordsJson ? JSON.parse(recordsJson) : [];
    }
    
    // 保存记录到localStorage
    function saveRecords(records) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
    }
    
    // 添加新记录
    function addRecord(record) {
        const records = getRecords();
        record.id = Date.now().toString(); // 时间戳作为唯一ID
        records.push(record);
        saveRecords(records);
        return record;
    }
    
    // 更新记录
    function updateRecord(updatedRecord) {
        const records = getRecords();
        const index = records.findIndex(r => r.id === updatedRecord.id);
        if (index !== -1) {
            records[index] = updatedRecord;
            saveRecords(records);
            return true;
        }
        return false;
    }
    
    // 删除记录
    function deleteRecord(id) {
        const records = getRecords();
        const newRecords = records.filter(r => r.id !== id);
        saveRecords(newRecords);
        return newRecords.length !== records.length;
    }
    
    // -------------------- 渲染记录 --------------------
    function renderRecords() {
        const allRecords = getRecords();
        
        // 1. 筛选记录（仅保留在筛选日期范围内的记录）
        const filteredRecords = allRecords.filter(record => {
            const recordDate = new Date(record.date);
            return recordDate >= filterStartDate && recordDate <= filterEndDate;
        });
        
        // 2. 无记录时显示空状态
        if (filteredRecords.length === 0) {
            tablesContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-tshirt"></i>
                    <p>暂无记录，点击右下角「+」添加</p>
                </div>
            `;
            updateStats(0, 0, 0, 0); // 统计清零
            return;
        }
        
        // 3. 按日期分组（日期字符串为键）
        const recordsByDate = {};
        filteredRecords.forEach(record => {
            const dateStr = record.date;
            if (!recordsByDate[dateStr]) {
                recordsByDate[dateStr] = [];
            }
            recordsByDate[dateStr].push(record);
        });
        
         // 4. 日期按"倒序"排序（最新日期在前）
        const sortedDates = Object.keys(recordsByDate).sort((a, b) => new Date(b) - new Date(a));
        
        // 5. 初始化统计变量
        let workDays = 0;     // 工作天数（有记录的日期数）
        let totalPieces = 0;  // 总件数
        let totalIncome = 0;  // 总收入
        const uniqueStyles = new Set(); // 去重后的款式种类
        
        // 清空容器，准备渲染新表格
        tablesContainer.innerHTML = '';
        
        // 6. 遍历每个日期，生成每日表格
        sortedDates.forEach(dateStr => {
            const dateRecords = recordsByDate[dateStr];
            const dateObj = new Date(dateStr);
            const month = dateObj.getMonth() + 1;
            const day = dateObj.getDate();
            const dateDisplay = `${month}月${day}日`;
            
            let dayPieces = 0;  // 当日总件数
            let dayIncome = 0;  // 当日总收入
            
            // 创建每日表格容器
            const dailyContainer = document.createElement('div');
            dailyContainer.className = 'daily-table-container';
            
            // 创建表格
            const table = document.createElement('table');
            table.className = 'records-table';
            
            // 表格表头
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th class="date-cell">日期</th>
                    <th class="size-cell">款式（尺码）</th>
                    <th class="quantity-cell">数量</th>
                    <th class="price-cell">单价</th>
                    <th class="total-cell">小计</th>
                    <th class="action-cell">操作</th>
                </tr>
            `;
            table.appendChild(thead);
            
            // 表格内容体
            const tbody = document.createElement('tbody');
            
            // 遍历当日每条记录，生成行
            dateRecords.forEach((record, index) => {
                const recordTotal = record.quantity * record.unitPrice;
                
                // 累加统计
                dayPieces += record.quantity;
                dayIncome += recordTotal;
                totalPieces += record.quantity;
                totalIncome += recordTotal;
                uniqueStyles.add(record.style); // 记录款式
                
                // 创建行
                const row = document.createElement('tr');
                
                // 只在第一行显示日期（合并单元格）
                if (index === 0) {
                    row.innerHTML = `
                        <td class="date-cell" rowspan="${dateRecords.length}">${dateDisplay}</td>
                        <td class="size-cell">${record.style}（${record.size}）</td>
                        <td class="quantity-cell">${record.quantity}</td>
                        <td class="price-cell">¥${record.unitPrice.toFixed(2)}</td>
                        <td class="total-cell">¥${recordTotal.toFixed(2)}</td>
                        <td class="action-cell">
                            <button class="action-btn edit-btn" data-id="${record.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" data-id="${record.id}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    `;
                } else {
                    row.innerHTML = `
                        <td class="size-cell">${record.style}（${record.size}）</td>
                        <td class="quantity-cell">${record.quantity}</td>
                        <td class="price-cell">¥${record.unitPrice.toFixed(2)}</td>
                        <td class="total-cell">¥${recordTotal.toFixed(2)}</td>
                        <td class="action-cell">
                            <button class="action-btn edit-btn" data-id="${record.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" data-id="${record.id}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    `;
                }
                tbody.appendChild(row);
            });
            
            // 当日合计行
            workDays++; // 有记录的日期+1
            const totalRow = document.createElement('tr');
            totalRow.className = 'day-total-row';
            totalRow.innerHTML = `
                <td colspan="2">当日合计</td>
                <td class="price-cell">${dayPieces}件</td>
                <td></td>
                <td class="total-cell">¥${dayIncome.toFixed(2)}</td>
                <td></td>
            `;
            tbody.appendChild(totalRow);
            
            table.appendChild(tbody);
            dailyContainer.appendChild(table);
            tablesContainer.appendChild(dailyContainer);
        });
        
        // 7. 更新统计信息到页面
        updateStats(workDays, totalPieces, uniqueStyles.size, totalIncome);
    }
    
    // 更新统计信息到DOM
    function updateStats(workDays, totalPieces, totalStyles, totalIncome) {
        workDaysEl.textContent = workDays;
        totalPiecesEl.textContent = totalPieces;
        totalStylesEl.textContent = totalStyles;
        monthIncomeEl.textContent = `¥${totalIncome.toFixed(2)}`;
        monthTotalAmountEl.textContent = `¥${totalIncome.toFixed(2)}`;
    }
    
    // -------------------- 模态框操作 --------------------
    // 打开"添加记录"模态框
    function openAddModal() {
        editingRecordId = null;
        document.getElementById('modal-title').textContent = '添加计件记录';
        document.getElementById('record-id').value = '';
        
        // 默认日期为今天（2025-06-07）
        const today = new Date('2025-06-07');
        document.getElementById('record-date').value = formatDate(today);
        
        // 款式默认值设为长裤
        clothingStyleSelect.value = '长裤';
        unitPriceInput.value = '7.5';
        document.getElementById('quantity').value = '1';
        document.getElementById('size').value = '32';
        customStyleGroup.style.display = 'none';
        
        recordModal.style.display = 'flex';
    }
    
    // 打开"编辑记录"模态框
    function openEditModal(id) {
        const records = getRecords();
        const record = records.find(r => r.id === id);
        if (!record) return;
        
        editingRecordId = id;
        document.getElementById('modal-title').textContent = '编辑计件记录';
        document.getElementById('record-id').value = id;
        
        // 回显数据
        document.getElementById('record-date').value = record.date;
        document.getElementById('quantity').value = record.quantity;
        unitPriceInput.value = record.unitPrice;
        document.getElementById('size').value = record.size;
        
        // 处理款式显示
        const styleOptions = Array.from(clothingStyleSelect.options).map(opt => opt.value);
        if (styleOptions.includes(record.style)) {
            clothingStyleSelect.value = record.style;
            customStyleGroup.style.display = 'none';
        } else {
            clothingStyleSelect.value = 'custom';
            customStyleInput.value = record.style;
            customStyleGroup.style.display = 'block';
        }
        
        recordModal.style.display = 'flex';
    }
    
    // 保存记录（添加/编辑）
    function saveRecord() {
        const date = document.getElementById('record-date').value;
        let style = clothingStyleSelect.value;
        const quantity = parseInt(document.getElementById('quantity').value);
        const unitPrice = parseFloat(unitPriceInput.value);
        const size = document.getElementById('size').value;
        
        // 使用自定义款式名称
        if (style === 'custom') {
            style = document.getElementById('custom-style').value.trim();
            if (!style) {
                showToast('请输入款式名称！', 'error');
                return;
            }
        }
        
        // 表单验证
        if (!date || !style || isNaN(quantity) || isNaN(unitPrice) || quantity < 1 || !size) {
            showToast('请填写有效信息！', 'error');
            return;
        }
        
        const newRecord = { date, style, quantity, unitPrice, size };
        
        if (editingRecordId) {
            newRecord.id = editingRecordId;
            if (updateRecord(newRecord)) {
                showToast('记录更新成功！', 'success');
            } else {
                showToast('更新失败，请重试！', 'error');
            }
        } else {
            addRecord(newRecord);
            showToast('记录添加成功！', 'success');
        }
        
        recordModal.style.display = 'none';
        renderRecords(); // 重新渲染表格
    }
    
    // 打开删除确认模态框
    function openDeleteModal(id) {
        recordToDelete = id;
        deleteConfirmModal.style.display = 'flex';
    }
    
    // 关闭删除确认模态框
    function closeDeleteModal() {
        deleteConfirmModal.style.display = 'none';
    }
    
    // 确认删除
    function confirmDelete() {
        if (recordToDelete) {
            if (deleteRecord(recordToDelete)) {
                showToast('记录已删除！', 'success');
                renderRecords(); // 重新渲染表格
            } else {
                showToast('删除失败，请重试！', 'error');
            }
            recordToDelete = null;
        }
        closeDeleteModal();
    }
    
    // -------------------- 日期筛选逻辑 --------------------
    // 应用日期筛选
    function applyDateFilter() {
        const startVal = startDateInput.value;
        const endVal = endDateInput.value;
        
        if (!startVal || !endVal) {
            showToast('请选择完整日期范围！', 'error');
            return;
        }
        
        const startDate = new Date(startVal);
        const endDate = new Date(endVal);
        
        if (startDate > endDate) {
            showToast('开始日期不能晚于结束日期！', 'error');
            return;
        }
        
        filterStartDate = startDate;
        filterEndDate = endDate;
        isFilterApplied = true;
        updateMonthDisplay();
        renderRecords();
        showToast('筛选已应用', 'success');
    }
    
    // 清除筛选（退出筛选状态）
    function clearDateFilter() {
        resetFilterDates(); // 重置为当月范围
        isFilterApplied = false;
        updateMonthDisplay();
        renderRecords();
        showToast('筛选已清除', 'success');
    }
    
    // -------------------- 提示Toast --------------------
    function showToast(message, type = 'success') {
        // 移除旧Toast
        const oldToast = document.querySelector('.toast');
        oldToast && oldToast.remove();
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
            <span>${message}</span>
        `;
        document.body.appendChild(toast);
        
        // 3秒后自动消失
        setTimeout(() => toast.remove(), 3000);
    }
</script>
</body>
</html>
